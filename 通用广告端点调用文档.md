# 通用广告端点调用文档

## 📋 概述

本文档详细介绍了CRM系统中通用广告端点的调用方法，该端点用于接收来自各种广告平台的线索数据。

## 🌐 端点信息

### 基础信息
- **服务器地址**: `8.159.132.181`
- **端口**: `3000`
- **协议**: `HTTP`
- **完整URL**: `http://8.159.132.181:3000/api/v1/leads/ingest/generic`

### 请求配置
- **请求方法**: `POST`
- **Content-Type**: `application/json`
- **认证**: 无需认证（已移除JWT认证）

## 📝 请求格式

### 基本请求结构
```json
{
  "leads": [
    {
      "external_id": "外部系统唯一ID",
      "phone": "手机号码",
      "wechat": "微信号",
      "qq": "QQ号",
      "location": "位置信息",
      "budget": "预算金额",
      "remark": "备注信息"
    }
  ],
  "platform": "海外站"
}
```

### 完整字段说明

| 字段名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| `external_id` | string | 是 | 外部系统唯一标识 | "ad_12345" |
| `phone` | string | 否 | 手机号码 | "13800138000" |
| `wechat` | string | 否 | 微信号 | "test_wechat" |
| `qq` | string | 否 | QQ号 | "123456789" |
| `location` | string | 否 | 位置信息 | "北京市朝阳区" |
| `budget` | string | 否 | 预算金额 | "10000" |
| `remark` | string | 否 | 备注信息 | "高意向客户" |
| `douyin_id` | string | 否 | 抖音ID | "douyin_123" |
| `douyin_nickname` | string | 否 | 抖音昵称 | "用户昵称" |
| `staffname` | string | 否 | 员工姓名 | "张三" |
| `redbook_id` | string | 否 | 小红书ID | "xhs_123" |
| `area` | string | 否 | 地区 | "华东地区" |
| `note_link` | string | 否 | 笔记链接 | "https://..." |
| `campaign_id` | string | 否 | 广告系列ID | "camp_123" |
| `campaign_name` | string | 否 | 广告系列名称 | "春季推广" |
| `unit_id` | string | 否 | 广告组ID | "unit_123" |
| `unit_name` | string | 否 | 广告组名称 | "搜索广告组" |
| `creative_id` | string | 否 | 创意ID | "creative_123" |
| `creative_name` | string | 否 | 创意名称 | "主图创意" |
| `lead_type` | string | 否 | 线索类型 | "表单线索" |
| `traffic_type` | string | 否 | 流量类型 | "付费流量" |
| `interaction_type` | string | 否 | 互动类型 | "点击" |
| `douyin_lead_id` | string | 否 | 抖音线索ID | "dy_lead_123" |

## 🔧 调用示例

### 1. cURL 示例
```bash
curl -X POST http://8.159.132.181:3000/api/v1/leads/ingest/generic \
  -H "Content-Type: application/json" \
  -d '{
    "leads": [
      {
        "external_id": "test_123",
        "phone": "13800138000",
        "wechat": "test_wechat",
        "location": "北京",
        "budget": "10000",
        "remark": "测试线索"
      }
    ],
    "platform": "海外站"
  }'
```

### 2. JavaScript 示例
```javascript
const response = await fetch('http://8.159.132.181:3000/api/v1/leads/ingest/generic', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    leads: [
      {
        external_id: "test_123",
        phone: "13800138000",
        wechat: "test_wechat",
        location: "北京",
        budget: "10000",
        remark: "测试线索"
      }
    ],
    platform: "海外站"
  })
});

const result = await response.json();
console.log(result);
```

### 3. Python 示例
```python
import requests
import json

url = "http://8.159.132.181:3000/api/v1/leads/ingest/generic"
headers = {"Content-Type": "application/json"}

data = {
    "leads": [
        {
            "external_id": "test_123",
            "phone": "13800138000",
            "wechat": "test_wechat",
            "location": "北京",
            "budget": "10000",
            "remark": "测试线索"
        }
    ],
    "platform": "海外站"
}

response = requests.post(url, headers=headers, data=json.dumps(data))
result = response.json()
print(result)
```

## 📊 响应格式

### 成功响应
```json
{
  "code": "200",
  "message": "success"
}
```

### 错误响应
```json
{
  "success": false,
  "error": "错误描述",
  "code": "错误代码",
  "timestamp": "2025-09-24T15:53:31.995Z"
}
```

## ⚠️ 重要注意事项

### 1. 平台名称限制
- **必须使用**: `"海外站"` 作为 platform 值
- **原因**: 数据库中的 source 字段有枚举限制
- **其他值**: 会导致数据库错误

### 2. 数据验证
- `external_id` 字段是必填的，用于唯一标识线索
- 系统会自动生成 `leadid` 格式：`{platform}_{external_id}_{timestamp}`
- 空值和无效值会被自动过滤

### 3. 数据映射
系统会自动将外部数据映射到内部数据库字段：
- `external_id` → 用于生成 `leadid`
- `platform` → 映射到 `source` 字段
- 其他字段直接映射到对应数据库列

## 🔍 健康检查

### 检查服务状态
```bash
curl http://8.159.132.181:3000/api/v1/health
```

### 响应示例
```json
{
  "success": true,
  "status": "healthy",
  "timestamp": "2025-09-24T15:53:22.597Z",
  "version": "1.0.0",
  "services": {
    "database": "connected"
  }
}
```

## 🛠️ 服务管理

### 服务器信息
- **IP地址**: 8.159.132.181
- **用户名**: root
- **服务目录**: /opt/ads-lead-api
- **进程管理**: PM2

### 常用管理命令
```bash
# 查看服务状态
pm2 status

# 重启服务
pm2 restart ads-lead-api

# 查看日志
pm2 logs ads-lead-api

# 停止服务
pm2 stop ads-lead-api

# 启动服务
pm2 start ads-lead-api
```

## 📈 性能特性

- **并发处理**: 支持多线程并发处理
- **批量插入**: 支持批量插入多条线索数据
- **错误处理**: 完善的错误处理和日志记录
- **数据验证**: 自动数据验证和清理
- **性能监控**: 内置性能监控和告警

## 🔒 安全说明

- **无认证**: 当前版本已移除JWT认证
- **数据脱敏**: 根据配置进行数据脱敏处理
- **日志记录**: 所有操作都有详细日志记录
- **错误处理**: 完善的错误处理机制

## 📞 技术支持

如有问题，请检查：
1. 网络连接是否正常
2. 服务是否运行正常
3. 请求格式是否正确
4. platform 值是否为 "海外站"

---

**文档版本**: 1.0.0  
**最后更新**: 2025-09-24  
**维护者**: CRM开发团队
